# SingleDraw Stage 1 – Mozaik Coordinate/Rotation Truth Harness

Stage 1 goal: crack Mozaik ↔ Three.js coordinate + rotation fidelity using real DES/MOZ/MOS files.
We are building a truth harness, not a closet designer.

---

## Scope (Stage 1 ONLY)

Must:
1) Load DES room files (walls + openings + room settings).
2) Load MOZ/MOS product files (product transforms + rotations).
3) Store all transforms in canonical Mozaik space unchanged.
4) Render in Three.js via an explicit, testable basis transform layer.
5) Export back using canonical Mozaik-space values (round-trip equivalence).

Hard out-of-scope:
- Auth/users/database/payments
- Drag/drop placement UI, snapping, param editing
- Certified module catalogs / "10 modules"
- Big geometry validation/type frameworks
- Any "smart" placement engine beyond minimal test packing
- Time-consuming UI polish beyond a clean debug shell

If a change does not improve coordinate truth, rotation truth, wall truth, opening truth, or round-trip truth, reject it.

---

## Tech Stack (Keep)

- Vite + React + TypeScript
- React Three Fiber + Drei (rendering engine)
- Tailwind CSS for a clean, minimal UI shell (Stage 1 may be pretty, but not complex)

UI philosophy:
- Debug-first, minimal controls: file load, toggles, numeric readouts
- Avoid any new interaction complexity

---

## Code Constraints (Non-negotiable)

- Keep each file under 500 lines (prefer < 300).
- No monolithic components (no 1000+ line App.tsx).
- Split by responsibility:
  - `src/mozaik/` (DES/MOZ parsers + schema normalization)
  - `src/math/` (basis transforms + rotations + wall normals)
  - `src/render/` (R3F scene + debug overlays + UI panels)
  - `src/export/` (round-trip writeback)
  - `src/tests/` (probe scenes + numeric diff report)

---

## Mozaik File Awareness (Required Behavior)

Whenever Claude Code reads or uses any Mozaik file (DES/MOZ/MOS/SBK/BAK/etc), it must:
- Explicitly announce it:
  - file name(s)
  - file type(s)
  - what it is extracting or using from it (walls, opening, transforms, rotations, etc.)

If Claude Code cannot locate a required Mozaik file locally (or does not have enough examples), it must:
- Stop and prompt the user to provide the missing file(s).
- Specify exactly what it needs and why (e.g., "I need a DES that contains the opening fixtures," "I need a MOZ with a non-zero Rot," etc.)
- Never fabricate data when files are missing.

---

## Units (Observed Reality)

Observed in provided files:
- DES and MOZ/MOS store many values in millimeters (e.g., 1778mm = 70", 2438.4mm = 96").

Stage 1 rule:
- Canonical storage = raw file units (mm) unchanged
- Rendering world units = mm (1 unit = 1 mm) to avoid drift
UI may display inches, but core math stays mm.

---

## Canonical Mozaik Space (Source of Truth)

- Axes:
  - X = width (left/right)
  - Y = depth (front/back)
  - Z = height (up/down)
- Origin (0,0,0) = Mozaik room bounding box front-left-bottom (as defined by Mozaik)
- Parts may lie outside bounding box; coordinates may be negative
Never clamp, recenter, or "fix" coordinates.

Mozaik-space values are what we export.

---

## Three.js Rendering Space (View Layer Only)

Three.js is view-layer only. Rendering uses a basis mapping.

Default mapping (explicit + testable):
- Position: (Xm, Ym, Zm) -> (Xt, Yt, Zt) = (Xm, Zm, -Ym)

If verification shows depth inverted, switch ONLY the sign:
- (Xm, Ym, Zm) -> (Xm, Zm, +Ym)

No other "creative" coordinate mappings.

### Mandatory Debug Overlays
Always show:
- origin marker
- axis gizmo
- floor grid
- wall inward normal arrows (toggle)
- product forward arrow (toggle)
- bounding boxes (toggle)
- option: double-sided walls on/off (toggle)

### Probe Tools (Generated by us, not from Mozaik)
Include a small probe scene tool for verification:
- points at origin and +X/+Y/+Z with labels
These probes prevent weeks of guesswork.

---

## Rotations (Stage 1 Requirement)

Rotations may be any degrees, including negative.
Do NOT guess sign flips.

Approach:
1) Parse Mozaik rotation representation from file (degrees about an axis / Euler if present).
2) Convert to rotation matrix/quaternion in Mozaik basis.
3) Apply the SAME Mozaik→Three basis change to the rotation (not just position).
4) Render via Three.js quaternion.

Mandatory rotation probe:
- DH96 rendered as simple box + forward-arrow indicator so yaw is obvious.

---

## Walls & Openings (from DES)

DES defines the room. Stage 1 must support:
- wall thickness, height, length, orientation
- multiple walls, joined corners
- openings displayed correctly

### Wall ID vs Wall UI Ordering
Important:
- Keep original wall IDs exactly as in the DES (because fixtures/products reference Wall="n").
- Also compute a view-only normalized wall ordering so that:
  - "Wall 1" in the plan UI starts at the leftmost point in plan view.

Rule for normalized plan ordering:
- Find the leftmost corner (minimum X; tie-breaker minimum Y).
- Choose traversal direction so the first wall proceeds in a consistent plan direction (document it).
- Display order uses normalized indices, but retain original wall IDs in data.

### Inward Normal ("into the room")
If walls form a closed loop:
- compute polygon winding in Mozaik XY (signed area)
  - CCW => interior is LEFT of each directed edge
  - CW  => interior is RIGHT
Store per wall:
- start/end (plan)
- tangent (along wall)
- inward normal (into room)

Walls render as plain planes/extrusions; no textures required.

### Openings
Must parse and render wall openings:
- Primary supported encoding: fixtures with Name="Opening" attached to a wall (e.g., 70" wide opening case)
- Also scan for alternative encodings: Door/Window/Opening-like nodes/attrs (log if found)
- If an opening is not present in the file, do NOT invent it — log clearly.

Render openings at minimum as:
- outline rectangle on the wall plane
- optional translucent overlay "cutout" visualization

---

## Minimal Test Placement Rule (Stage 1 Only)

We do NOT build a placement engine.

For test placement only:
- First DH96 drops "left-inside" of a selected wall:
  - start at wall start
  - inset along inward normal
- Subsequent modules pack to the right along wall tangent, adjacent to previous.

If placement grows beyond this, it is out of scope.

---

## Verification Loop (Required)

Always follow:
Plan → Implement → Verify → Log expected vs actual → Iterate

Verification must include at least one of:
- screenshot check (debug overlays)
- numeric diff report
- probe scenes

---

## Definition of Done (Stage 1)

- Load DES and render walls correctly, with correct wall IDs preserved and normalized plan ordering for UI.
- Render openings correctly (including 70" opening case).
- Load MOZ/MOS products and render correctly (position + rotation).
- Export back with no drift.
- Round-trip: import → export → re-import yields identical transforms (epsilon=0 unless Mozaik quantizes; only relax epsilon if proven).
